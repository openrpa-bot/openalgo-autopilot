<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration Management - OpenAlgo Autopilot</title>
    <link rel="stylesheet" th:href="@{/css/app.css}">
    <style>
        .config-section {
            margin-bottom: 2rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1.5rem;
            background: #f9f9f9;
        }
        .config-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 0.5rem;
        }
        .config-item {
            display: grid;
            grid-template-columns: 2fr 3fr 1fr auto;
            gap: 1rem;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: white;
            border-radius: 4px;
            align-items: center;
        }
        .config-key {
            font-weight: bold;
            color: #007bff;
            word-break: break-all;
        }
        .config-value {
            font-family: monospace;
            background: #f5f5f5;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            word-break: break-all;
        }
        .config-source {
            font-size: 0.85rem;
            color: #666;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .badge-ui { background: #28a745; color: white; }
        .badge-redis { background: #dc3545; color: white; }
        .badge-env { background: #ffc107; color: black; }
        .badge-props { background: #6c757d; color: white; }
        .btn-group {
            display: flex;
            gap: 0.5rem;
        }
        .btn {
            padding: 0.375rem 0.75rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 0.875rem;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .filter-section {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div th:replace="~{fragments/header :: samples-header}"></div>

    <div class="container" style="max-width: 1400px; margin: 2rem auto; padding: 0 1rem;">
        <h1>Configuration Management</h1>
        <p>Manage application configuration with priority: UI Override &gt; Redis &gt; Environment &gt; Properties File</p>

        <!-- Flash Messages -->
        <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}"></div>

        <!-- Filter Section -->
        <div class="filter-section">
            <label><strong>Filter by Category:</strong></label>
            <a th:href="@{/configuration}" 
               th:class="${selectedCategory == null} ? 'btn btn-primary' : 'btn'"
               style="text-decoration: none;">All</a>
            <a th:each="cat : ${categories}"
               th:href="@{/configuration(category=${cat})}"
               th:text="${cat}"
               th:class="${selectedCategory != null and selectedCategory == cat} ? 'btn btn-primary' : 'btn'"
               style="text-decoration: none; margin-left: 0.5rem;"></a>
            <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: center;">
                <form th:action="@{/configuration/reset-all}" method="post" style="display: inline;" id="resetAllForm">
                    <button type="submit" 
                            class="btn" 
                            style="background: #ffc107; color: black;"
                            th:disabled="${overrideCount == 0}"
                            th:onclick="|return confirm('âš ï¸ WARNING: This will delete ALL ${overrideCount} configuration override(s) and restore all values to their defaults from application.properties. This action cannot be undone. Are you sure?');|">
                        ðŸ”„ Reset All Overrides
                        <span th:if="${overrideCount > 0}" th:text="'(' + ${overrideCount} + ')'" style="margin-left: 0.25rem;"></span>
                    </button>
                </form>
                <a th:href="@{/configuration/edit}" class="btn btn-success">+ Add New Configuration</a>
            </div>
        </div>

        <!-- Configuration Sections by Category -->
        <div th:if="${configsByCategory.isEmpty()}">
            <div class="alert">
                <p>No configurations found. <a th:href="@{/configuration/edit}">Add a new configuration</a></p>
            </div>
        </div>

        <div th:each="categoryEntry : ${configsByCategory}">
            <div class="config-section">
                <h3 th:text="${categoryEntry.key}">Category</h3>
                <div th:each="config : ${categoryEntry.value}" class="config-item">
                    <div class="config-key" th:text="${config.key}">key</div>
                    <div class="config-value" th:text="${config.currentValue}">value</div>
                    <div class="config-source">
                        <span th:switch="${config.source}">
                            <span th:case="'UI_OVERRIDE'" class="badge badge-ui">UI Override</span>
                            <span th:case="'REDIS'" class="badge badge-redis">Redis</span>
                            <span th:case="'ENVIRONMENT'" class="badge badge-env">Environment</span>
                            <span th:case="'PROPERTIES_FILE'" class="badge badge-props">Properties</span>
                            <span th:case="*" class="badge" th:text="${config.source}">Source</span>
                        </span>
                    </div>
                    <div class="btn-group">
                        <a th:href="@{'/configuration/edit?key=' + ${config.key}}" class="btn btn-primary">Edit</a>
                        <form th:action="@{/configuration/delete}" method="post" style="display: inline;">
                            <input type="hidden" th:name="key" th:value="${config.key}">
                            <button type="submit" class="btn btn-danger" 
                                    onclick="return confirm('Are you sure you want to delete this configuration override?')">Delete</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/footer :: appFooter}"></div>
</body>
</html>
